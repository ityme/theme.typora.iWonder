name: Release Theme

on:
  push:
    branches:
      - main
    tags:
      - 'v*'

jobs:
  create-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4


      - name: Create zip archive
        run: |
          # 获取tag名称（不含v前缀）
          TAG_NAME=${GITHUB_REF#refs/tags/v}
          ZIP_NAME="theme.typora.iWonder-v${TAG_NAME}.zip"
          
          # 创建临时目录用于打包
          mkdir -p temp_package
          
          # 复制所有文件到临时目录，除了bug.md和.git
          mv iWonder temp_package/
          mv ref temp_package/
          mv conf.user.json temp_package/    
          mv i-w-*.css temp_package/
          mv install.bat temp_package/
          mv LICENSE temp_package/
          mv README.md temp_package/

          # 创建zip压缩包
          cd temp_package
          zip -r "../${ZIP_NAME}" .
          cd ..
          
          # 验证zip文件
          ls -lh "${ZIP_NAME}"
          
          # 保存ZIP_NAME供下一步使用
          echo "ZIP_NAME=${ZIP_NAME}" >> $GITHUB_ENV
          echo "TAG_NAME=${TAG_NAME}" >> $GITHUB_ENV

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.ZIP_NAME }}
          tag_name: v${{ env.TAG_NAME }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup
        if: always()
        run: rm -rf temp_package
